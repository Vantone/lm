<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»åŠ¨ç«¯è¿æ¥æµ‹è¯•</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto;
            background: #f5f5f5;
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .step { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; }
        .step h3 { margin-top: 0; color: #333; }
        code { 
            background: #f8f9fa; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-family: 'Monaco', 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç§»åŠ¨ç«¯è¿æ¥è¯Šæ–­å·¥å…·</h1>
    
    <div class="step">
        <h3>æ­¥éª¤1: ç½‘ç»œä¿¡æ¯</h3>
        <div id="network-info" class="status info">
            æ­£åœ¨æ£€æµ‹ç½‘ç»œä¿¡æ¯...
        </div>
    </div>

    <div class="step">
        <h3>æ­¥éª¤2: è¿æ¥æµ‹è¯•</h3>
        <button onclick="testConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <button onclick="testAllEndpoints()">æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹</button>
        <div id="connection-status" class="status info">
            ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•
        </div>
    </div>

    <div class="step">
        <h3>æ­¥éª¤3: æ¨èè§£å†³æ–¹æ¡ˆ</h3>
        <div id="solutions" class="status warning">
            è¯·å…ˆå®Œæˆè¿æ¥æµ‹è¯•
        </div>
    </div>

    <div class="step">
        <h3>æ­¥éª¤4: æ‰‹åŠ¨è®¿é—®æµ‹è¯•</h3>
        <p>è¯·æ‰‹åŠ¨æµ‹è¯•ä»¥ä¸‹åœ°å€ï¼š</p>
        <ul>
            <li><code id="test-url-1">http://localhost:3001/api/data</code></li>
            <li><code id="test-url-2">http://[ä½ çš„IP]:3001/api/data</code></li>
            <li><code id="test-url-3">http://localhost:5173</code></li>
        </ul>
    </div>

    <script>
        // æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
        function showNetworkInfo() {
            const info = document.getElementById('network-info');
            const userAgent = navigator.userAgent;
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            info.innerHTML = `
                <strong>è®¾å¤‡ç±»å‹:</strong> ${isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'æ¡Œé¢è®¾å¤‡'}<br>
                <strong>æµè§ˆå™¨:</strong> ${userAgent.split(' ')[0]}<br>
                <strong>å½“å‰URL:</strong> ${window.location.href}<br>
                <strong>ä¸»æœºåœ°å€:</strong> ${window.location.hostname}<br>
                <strong>ç«¯å£:</strong> ${window.location.port || 'é»˜è®¤'}
            `;
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const status = document.getElementById('connection-status');
            status.className = 'status info';
            status.innerHTML = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';

            // å°è¯•å¤šä¸ªå¯èƒ½çš„APIåœ°å€
            const testUrls = [
                `${window.location.protocol}//${window.location.hostname}:3001/api/data`,
                'http://localhost:3001/api/data',
                '/api/data'
            ];

            let connected = false;
            let workingUrl = '';

            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { 
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        connected = true;
                        workingUrl = url;
                        status.className = 'status success';
                        status.innerHTML = `
                            <strong>âœ… è¿æ¥æˆåŠŸ!</strong><br>
                            å·¥ä½œåœ°å€: <code>${url}</code><br>
                            æ•°æ®æ¦‚è§ˆ: ç‰©æ–™${data.materials?.length || 0}ä¸ª, è®°å½•${data.records?.length || 0}æ¡
                        `;
                        break;
                    }
                } catch (e) {
                    console.log(`æµ‹è¯• ${url} å¤±è´¥:`, e.message);
                }
            }

            if (!connected) {
                status.className = 'status error';
                status.innerHTML = `
                    <strong>âŒ æ‰€æœ‰è¿æ¥æµ‹è¯•å¤±è´¥</strong><br>
                    è¯·æ£€æŸ¥ï¼š<br>
                    1. åç«¯æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨<br>
                    2. é˜²ç«å¢™è®¾ç½®<br>
                    3. ç½‘ç»œè¿æ¥<br>
                    4. CORSé…ç½®
                `;
            }

            updateSolutions(connected, workingUrl);
        }

        // æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
        async function testAllEndpoints() {
            const status = document.getElementById('connection-status');
            status.className = 'status info';
            status.innerHTML = 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹...';

            const baseUrl = `${window.location.protocol}//${window.location.hostname}:3001`;
            const endpoints = ['/api/data', '/api/login'];

            let results = '';

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(baseUrl + endpoint, { 
                        method: endpoint === '/api/login' ? 'POST' : 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: endpoint === '/api/login' ? 
                            { 'Content-Type': 'application/json' } : {},
                        body: endpoint === '/api/login' ? 
                            JSON.stringify({ username: 'test', password: 'test' }) : undefined
                    });
                    
                    results += `${endpoint}: ${response.status} ${response.statusText}<br>`;
                } catch (e) {
                    results += `${endpoint}: è¿æ¥å¤±è´¥ - ${e.message}<br>`;
                }
            }

            status.className = 'status info';
            status.innerHTML = `<strong>APIç«¯ç‚¹æµ‹è¯•ç»“æœ:</strong><br>${results}`;
        }

        // æ›´æ–°è§£å†³æ–¹æ¡ˆ
        function updateSolutions(connected, workingUrl) {
            const solutions = document.getElementById('solutions');
            
            if (connected) {
                solutions.className = 'status success';
                solutions.innerHTML = `
                    <strong>âœ… è¿æ¥æ­£å¸¸!</strong><br>
                    å·¥ä½œåœ°å€: <code>${workingUrl}</code><br>
                    å¦‚æœä¸»åº”ç”¨ä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                    1. å‰ç«¯æ˜¯å¦æ­£ç¡®åŠ è½½<br>
                    2. JavaScriptæ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯<br>
                    3. localStorageæ˜¯å¦è¢«ç¦ç”¨
                `;
            } else {
                solutions.className = 'status error';
                solutions.innerHTML = `
                    <strong>ğŸ”§ æ¨èè§£å†³æ–¹æ¡ˆ:</strong><br>
                    1. <strong>å¯åŠ¨åç«¯:</strong> åœ¨ç”µè„‘ä¸Šè¿è¡Œ <code>node server.js</code><br>
                    2. <strong>æ£€æŸ¥é˜²ç«å¢™:</strong> å…è®¸3001å’Œ5173ç«¯å£<br>
                    3. <strong>ä½¿ç”¨IPè®¿é—®:</strong> ä¸è¦ç”¨localhostï¼Œç”¨ç”µè„‘çš„IPåœ°å€<br>
                    4. <strong>åŒä¸€ç½‘ç»œ:</strong> ç¡®ä¿æ‰‹æœºå’Œç”µè„‘è¿æ¥åŒä¸€WiFi<br>
                    5. <strong>é‡å¯åº”ç”¨:</strong> å®Œå…¨å…³é—­æµè§ˆå™¨åé‡æ–°æ‰“å¼€<br>
                    <br>
                    <strong>è·å–IPåœ°å€å‘½ä»¤:</strong><br>
                    Windows: <code>ipconfig</code><br>
                    Mac: <code>ifconfig</code>
                `;
            }
        }

        // åˆå§‹åŒ–
        showNetworkInfo();
        
        // æ›´æ–°æµ‹è¯•URLæ˜¾ç¤º
        const hostname = window.location.hostname;
        document.getElementById('test-url-2').textContent = 
            `http://${hostname}:3001/api/data`;
    </script>
</body>
</html>