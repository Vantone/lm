# 第二天数据生成逻辑说明

## 📅 数据生成原理

### 1. 昨日库存生成逻辑

第二天数据的"昨日库存"是按照以下逻辑自动生成的：

```javascript
// 优先使用今天的当前库存作为昨日的库存
const yesterdayStock = todayRecord ? 
  todayRecord.currentStock : 
  (latestRecord ? latestRecord.currentStock : 0);
```

**具体逻辑：**
- **如果存在今天(2024-01-15)的记录**：今天记录的`currentStock` → 明天(2024-01-16)的`yesterdayStock`
- **如果不存在今天的记录**：查找该物料最新的历史记录，使用其`currentStock`作为明天的`yesterdayStock`
- **如果没有任何历史记录**：昨日库存为0

### 2. 自动触发条件

系统会在以下情况下自动生成第二天数据：
- 用户访问仓库管理页面时
- 系统初始化时检测到有物料但没有对应日期的记录
- 手动调用`dataService.generateNextDayRecords()`方法

### 3. 数据生成示例

假设今天是2024-01-15，存在如下记录：

| 物料 | 日期 | 昨日库存 | 入库 | 出库 | 当前库存 |
|------|------|----------|------|------|----------|
| 大米 | 2024-01-15 | 100 | 10 | 5 | 105 |

自动生成2024-01-16的记录：

| 物料 | 日期 | 昨日库存 | 入库 | 出库 | 当前库存 |
|------|------|----------|------|------|----------|
| 大米 | 2024-01-16 | 105 | 0 | 0 | 105 |

### 4. 代码实现位置

**前端实现：** `services/dataService.ts` → `generateNextDayRecords()`方法

**核心算法：**
```typescript
// 查找今天的记录
const todayRecord = allRecords.find(r => r.materialId === material.id && r.date === today);

// 使用今天的当前库存作为昨日的库存
const yesterdayStock = todayRecord ? 
  todayRecord.currentStock : 
  (latestRecord ? latestRecord.currentStock : 0);
```

### 5. 审计日志记录

每次自动生成数据时，系统会记录审计日志：
```
操作类型：自动生成次日数据
操作详情：为 X 个物料生成了 YYYY-MM-DD 的库存记录
操作用户：系统（或当前登录用户）
```

### 6. 手动调用方式

如果需要手动生成第二天数据：

```typescript
import { dataService } from './services/dataService';

// 生成明天的库存记录
const newRecords = dataService.generateNextDayRecords();
console.log(`生成了 ${newRecords.length} 条新记录`);
```

### 7. 注意事项

1. **数据连续性**：系统会确保库存数据的连续性，避免库存数量断裂
2. **零值初始化**：新生成的记录，入库和出库默认为0
3. **避免重复**：如果明天已有记录，不会重复生成
4. **审计追踪**：所有自动生成操作都会记录在审计日志中

---

## 📁 新的目录结构

### data/ 目录
```
data/
├── database.json          # 主数据库文件
└── (不再自动生成备份文件)
```

### logs/ 目录
```
logs/
├── audit_2024-01-15.log  # 按日期分割的审计日志
├── audit_2024-01-16.log
└── ...
```

### 审计日志格式
```json
{"timestamp":"2024-01-15T10:30:00.000Z","user":"admin","ip":"192.168.1.100","action":"物料添加","details":"添加了 3 个物料，当前总数：15"}
```

---

## 🔧 服务器配置修改

1. **数据存储路径**：从根目录 `database.json` → `data/database.json`
2. **备份机制**：已移除自动备份功能，直接修改原文件
3. **日志记录**：新增独立的审计日志系统，按日期分割存储
4. **变更追踪**：智能分析数据变化并记录相应的审计日志